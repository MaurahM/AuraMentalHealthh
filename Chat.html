<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Conversational AI</title>
<style>
  :root{
    --bg:#3b1534;
    --panel:#5a2450;
    --muted:#d9c9dc;
    --pink:#ff2fa6;
    --bubble-left:#e6e0e7;
    --bubble-right:linear-gradient(90deg,#d94aa0,#ff5aa8);
    --white:#ffffff;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--white)}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box}
  .panel{width:100%;max-width:1000px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:8px;padding:24px;box-shadow:0 20px 50px rgba(0,0,0,0.5);display:flex;flex-direction:column;gap:12px;box-sizing:border-box}
  .header{display:flex;align-items:center;justify-content:space-between}
  .title{font-weight:700;letter-spacing:0.6px}
  .chat-area{background:transparent;border-radius:8px;flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:360px}
  .messages{flex:1;overflow:auto;padding:22px 18px;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth}
  .msg{max-width:72%;padding:12px 16px;border-radius:20px;box-sizing:border-box;line-height:1.2;word-wrap:break-word}
  .left{align-self:flex-start;background:var(--bubble-left);color:#333;border-bottom-left-radius:6px}
  .right{align-self:flex-end;background:var(--bubble-right);color:#fff;border-bottom-right-radius:6px}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);align-items:center;justify-content:space-between}
  .input{flex:1;background:rgba(0,0,0,0.15);border-radius:999px;padding:12px 14px;border:0;color:var(--white);outline:none;resize:none;min-height:44px;max-height:120px;margin:0 8px;}
  .btn{background:linear-gradient(90deg,var(--pink),#ff5aa8);border:0;color:#fff;padding:10px 12px;border-radius:999px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .btn-clear{
    background: rgba(255,255,255,0.1);
    color: var(--pink);
    border: 1px solid var(--pink);
    padding: 10px 12px;
    border-radius: 999px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
  }
  .btn-clear:hover{
    background: rgba(255,47,166,0.1);
  }
  .hint{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}
  @media (max-width:760px){
    .panel{padding:16px}
    .messages{padding:16px}
    .msg{max-width:86%}
  }
</style>
<script src="theme-manager.js"></script>
</head>

<body>
<script>
    // --- ðŸ”‘ AUTHENTICATION GUARD ---
    const TOKEN_KEY = 'convai_user_token';
    const token = localStorage.getItem(TOKEN_KEY);

    if (!token) {
        window.location.href = 'index.html';
    }
</script>

<main class="wrap" role="main" aria-labelledby="chatTitle">
    <section class="panel" aria-labelledby="chatTitle">
      <div class="header">
        <div class="title" id="chatTitle">Chat with Aura</div>
        <div style="font-size:13px;color:var(--muted)">
          <a href="Dashboard.html" style="color:var(--pink);text-decoration:none">Back</a>
        </div>
      </div>

      <div class="chat-area" role="application" aria-live="polite" aria-atomic="false">
        <div id="messages" class="messages" role="list" aria-label="Messages">
          </div>

        <div class="composer" role="region" aria-label="Message composer">
          <button id="clear" class="btn-clear" aria-label="Clear chat" title="Clear Chat">Clear</button>
          <textarea id="input" class="input" placeholder="Type something..." rows="1" aria-label="Message"></textarea>
          <button id="send" class="btn" aria-label="Send message" title="Send">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="https://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#fff"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="hint">Press Enter to send / Shift+Enter for new line</div>
      <a class="btn-ghost" href="Escalation.html">Emergency Services</a>
    </section>
</main>

<script>
(function () {
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const clearBtn = document.getElementById("clear");

    // FIX 1: Ensure we use the SAME token key as the guard script
    const TOKEN_KEY = 'convai_user_token';
    const token = localStorage.getItem(TOKEN_KEY);

    const BASE_API_URL = "https://auramentalhealthh-production.up.railway.app/api/chat";
    
    const getHeaders = () => ({
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    });

    function escapeHtml(s = "") {
        return String(s).replace(/[&<>"']/g, (c) => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;",
        })[c]);
    }

    function appendMessage(text, side = "right", who = "") {
        const wrap = document.createElement("div");
        wrap.className = `msg ${side}`;
        wrap.setAttribute("role", "listitem");
        if (who) {
            const meta = document.createElement("div");
            meta.className = "meta";
            meta.textContent = who;
            wrap.appendChild(meta);
        }
        const textNode = document.createElement("div");
        textNode.innerHTML = escapeHtml(text).replace(/\n/g, "<br>");
        wrap.appendChild(textNode);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTyping() {
        const node = document.createElement("div");
        node.className = "msg left typing";
        node.setAttribute("role", "status");
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = "Aura ðŸ’—";
        const dots = document.createElement("div");
        dots.innerHTML = "&#8230;";
        node.appendChild(meta);
        node.appendChild(dots);
        messagesEl.appendChild(node);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return node;
    }

    // FIX 2: Correctly load history and clear placeholder
    async function loadChatHistory() {
        try {
            const res = await fetch(`${BASE_API_URL}/history`, {
                method: 'GET',
                headers: getHeaders()
            });
            if (res.ok) {
                const data = await res.json();
                messagesEl.innerHTML = ""; // Clear current view
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const side = msg.sender === 'user' ? 'right' : 'left';
                        const who = msg.sender === 'user' ? 'You' : 'Aura ðŸ’—';
                        appendMessage(msg.text, side, who);
                    });
                } else {
                    appendMessage("Hello! I'm Aura. I'm here to listen.", 'left', 'Aura ðŸ’—');
                }
            }
        } catch (err) {
            console.error('Failed to load history:', err);
        }
    }

    async function send() {
        const raw = inputEl.value.trim();
        if (!raw || sendBtn.disabled) return;

        appendMessage(raw, "right", "You");
        inputEl.value = "";
        inputEl.style.height = "auto";
        sendBtn.disabled = true;
        const typingNode = showTyping();

        try {
            const res = await fetch(`${BASE_API_URL}/message`, {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify({ message: raw })
            });
            const data = await res.json();
            typingNode.remove();
            if (res.ok) {
                appendMessage(data.response, "left", "Aura ðŸ’—");
            } else {
                appendMessage("I'm having trouble connecting. Please try again.", "left", "Aura ðŸ’—");
            }
        } catch (err) {
            if (typingNode) typingNode.remove();
            appendMessage("Server error. Check your connection.", "left", "Aura ðŸ’—");
        } finally {
            sendBtn.disabled = false;
            inputEl.focus();
        }
    }

    clearBtn.addEventListener("click", async () => {
        if (!confirm("Clear chat?")) return;
        try {
            await fetch(`${BASE_API_URL}/history`, { method: "DELETE", headers: getHeaders() });
            messagesEl.innerHTML = "";
            appendMessage("How can I support you now?", "left", "Aura ðŸ’—");
        } catch (err) { console.error(err); }
    });

    inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });

    sendBtn.addEventListener("click", send);
    inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + "px";
    });

    loadChatHistory();
})();
</script>
</body>
</html>