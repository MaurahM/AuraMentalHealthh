<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Conversational AI</title>
<style>
  :root{
    --bg:#3b1534;
    --panel:#5a2450;
    --muted:#d9c9dc;
    --pink:#ff2fa6;
    --bubble-left:#e6e0e7;
    --bubble-right:linear-gradient(90deg,#d94aa0,#ff5aa8);
    --white:#ffffff;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--white)}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box}
  .panel{width:100%;max-width:1000px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:8px;padding:24px;box-shadow:0 20px 50px rgba(0,0,0,0.5);display:flex;flex-direction:column;gap:12px;box-sizing:border-box}
  .header{display:flex;align-items:center;justify-content:space-between}
  .title{font-weight:700;letter-spacing:0.6px}
  .chat-area{background:transparent;border-radius:8px;flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:360px}
  .messages{flex:1;overflow:auto;padding:22px 18px;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth}
  .msg{max-width:72%;padding:12px 16px;border-radius:20px;box-sizing:border-box;line-height:1.2;word-wrap:break-word; animation: fadeIn 0.3s ease;}
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  .left{align-self:flex-start;background:var(--bubble-left);color:#333;border-bottom-left-radius:6px}
  .right{align-self:flex-end;background:var(--bubble-right);color:#fff;border-bottom-right-radius:6px}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);align-items:center;justify-content:space-between}
  .input{flex:1;background:rgba(0,0,0,0.15);border-radius:999px;padding:12px 14px;border:0;color:var(--white);outline:none;resize:none;min-height:44px;max-height:120px;margin:0 8px;}
  .btn{background:linear-gradient(90deg,var(--pink),#ff5aa8);border:0;color:#fff;padding:10px 12px;border-radius:999px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition: transform 0.2s;}
  .btn:active{transform: scale(0.9);}
  .btn-clear{
    background: rgba(255,255,255,0.1);
    color: var(--pink);
    border: 1px solid var(--pink);
    padding: 10px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 500;
  }
  .hint{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}
  .btn-ghost{color: #ffadad; text-decoration: none; font-size: 14px; text-align: center; display: block; margin-top: 10px;}
  @media (max-width:760px){ .panel{padding:16px} .msg{max-width:86%} }
</style>
</head>

<body>
<script>
    const TOKEN_KEY = 'convai_user_token';
    const token = localStorage.getItem(TOKEN_KEY);
    if (!token) { window.location.href = 'index.html'; }
</script>

<main class="wrap">
    <section class="panel">
      <div class="header">
        <div class="title">Chat with Aura ðŸ’—</div>
        <div style="font-size:13px;"><a href="Dashboard.html" style="color:var(--pink);text-decoration:none">Back</a></div>
      </div>

      <div class="chat-area">
        <div id="messages" class="messages">
          </div>

        <div class="composer">
          <button id="clear" class="btn-clear">Clear</button>
          <textarea id="input" class="input" placeholder="Type something..." rows="1"></textarea>
          <button id="send" class="btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#fff"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="hint">Press Enter to send / Shift+Enter for new line</div>
      <a class="btn-ghost" href="Escalation.html">Emergency Services</a>
    </section>
</main>

<script>
(function () {
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const clearBtn = document.getElementById("clear");

    const token = localStorage.getItem('convai_user_token');
    const BASE_API_URL = "https://auramentalhealthh-production.up.railway.app/api/chat";
    
    const getHeaders = () => ({
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    });

    function appendMessage(text, side = "right", who = "") {
        const wrap = document.createElement("div");
        wrap.className = `msg ${side}`;
        if (who) {
            const meta = document.createElement("div");
            meta.className = "meta";
            meta.textContent = who;
            wrap.appendChild(meta);
        }
        const textNode = document.createElement("div");
        textNode.style.whiteSpace = "pre-wrap";
        textNode.textContent = text;
        wrap.appendChild(textNode);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function loadChatHistory() {
        try {
            const res = await fetch(`${BASE_API_URL}/history`, { method: 'GET', headers: getHeaders() });
            if (res.ok) {
                const data = await res.json();
                messagesEl.innerHTML = ""; 
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        appendMessage(msg.text, msg.sender === 'user' ? 'right' : 'left', msg.sender === 'user' ? 'You' : 'Aura ðŸ’—');
                    });
                } else {
                    appendMessage("Hello Love, I'm Aura. I'm here to listen.", "left", "Aura ðŸ’—");
                }
            }
        } catch (err) { console.error('History failed:', err); }
    }

    async function send() {
        const message = inputEl.value.trim();
        if (!message || sendBtn.disabled) return;

        appendMessage(message, "right", "You");
        inputEl.value = "";
        inputEl.style.height = "auto";
        sendBtn.disabled = true;

        try {
            const res = await fetch(`${BASE_API_URL}/message`, {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify({ message })
            });

            if (!res.ok) throw new Error();

            const data = await res.json();
            appendMessage(data.response, "left", "Aura ðŸ’—");
        } catch (err) {
            appendMessage("I'm feeling a bit overwhelmed. Could you try sending that again?", "left", "Aura ðŸ’—");
        } finally {
            sendBtn.disabled = false;
        }
    }

    clearBtn.addEventListener("click", async () => {
        if (!confirm("Clear our history?")) return;
        try {
            await fetch(`${BASE_API_URL}/history`, { method: "DELETE", headers: getHeaders() });
            messagesEl.innerHTML = "";
            appendMessage("I'm ready to start fresh. How are you?", "left", "Aura ðŸ’—");
        } catch (err) { console.error(err); }
    });

    inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
    });
    sendBtn.addEventListener("click", send);
    loadChatHistory();
})();
</script>
</body>
</html>