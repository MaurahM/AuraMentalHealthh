<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meditation — Conversational AI</title>
  <link rel="preload" href="/css/style.css" as="style" onload="this.rel='stylesheet'">
  <style>
    :root{
      --bg-dark: #220c1e;
      --panel: #4e2246;
      --accent: #ff2fa6;
      --soft: #ffd7f0;
      --muted: #e0d5e2;
      --pill: #ffffff;
      --white: #ffffff;
      --shadow-heavy: rgba(0,0,0,0.6);
      --shadow-soft: rgba(0,0,0,0.28);
    }

    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg-dark); color:var(--white)}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:32px;box-sizing:border-box}
    .panel{width:100%;max-width:1000px;background:var(--panel);border-radius:16px;padding:28px;box-shadow:0 30px 80px var(--shadow-heavy);border:1px solid rgba(255,255,255,0.04)}
    .header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:20px}
    .title{font-weight:700;font-size:22px}
    .subtitle{color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:20px}
    .card{background:linear-gradient(145deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border-radius:14px;padding:20px;display:flex;flex-direction:column;align-items:center;gap:12px;min-height:140px;justify-content:center;box-shadow:0 8px 24px var(--shadow-soft);border:1px solid rgba(255,255,255,0.06);cursor:pointer;transition:transform .14s,box-shadow .14s}
    .card:hover,.card:focus{transform:translateY(-4px);box-shadow:0 18px 50px var(--shadow-heavy);border-color:var(--accent)}
    .card:focus{outline:3px solid rgba(255,223,240,0.15);outline-offset:6px}
    .cute-badge{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--pill);box-shadow:0 6px 18px rgba(0,0,0,0.2)}
    .badge-ico{width:32px;height:32px;fill:var(--accent)}
    .card h3{margin:0;font-size:16px}
    .card p{margin:0;font-size:13px;color:var(--muted);text-align:center}

    .btn{background:linear-gradient(90deg,var(--accent),#ff5aa8);color:#fff;border:0;padding:10px 16px;border-radius:999px;cursor:pointer}
    .btn-ghost{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:10px}

    .note{color:var(--muted);text-align:center;margin-top:16px}

    /* modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:1000;padding:18px}
    .modal{background:var(--bg-dark);padding:20px;border-radius:12px;max-width:720px;width:100%;box-shadow:0 40px 120px var(--shadow-heavy);color:var(--white);max-height:92vh;overflow:auto;border:1px solid rgba(255,47,166,0.06)}
    .modal h2{margin:0 0 6px}
    .meta{color:var(--accent);margin-bottom:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .timer{font-weight:800;font-size:28px;padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.03);min-width:110px;text-align:center;color:var(--soft)}
    .presets{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .preset{background:rgba(255,255,255,0.03);color:var(--muted);padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .guide{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;margin-top:14px;color:var(--muted);line-height:1.6}

    @media (max-width:640px){.panel{padding:18px}.grid{gap:14px}}
  </style>
  <script src="theme-manager.js"></script>
</head>
<body>
  <!-- AUTH GUARD -->
  <script>
    const TOKEN_KEY = 'convai_user_token';
    const token = localStorage.getItem(TOKEN_KEY);
    if (!token) window.location.href = 'index.html';
  </script>

  <main class="wrap" role="main" aria-labelledby="medTitle">
    <section class="panel" aria-labelledby="medTitle">
      <div class="header">
        <div>
          <div id="medTitle" class="title">Meditation Practices</div>
          <div class="subtitle">Short practices to calm attention and support wellbeing. Pick one to view guidance and start a timer.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <a href="Dashboard.html" class="btn-ghost">Back</a>
        </div>
      </div>

      <div class="grid" id="practices" role="list"></div>
      <div class="note">Tip: use presets in the session modal to quickly choose a length. A gentle bell plays at start and end.</div>
    </section>
  </main>

  <div id="backdrop" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2 id="modalTitle">Practice</h2>
          <div id="modalSub" class="meta">Guide</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="timer" id="timer">05:00</div>
          <div class="controls" role="group" aria-label="Timer controls">
            <button id="startBtn" class="btn">Start</button>
            <button id="pauseBtn" class="btn-ghost">Pause</button>
            <button id="resetBtn" class="btn-ghost">Reset</button>
          </div>
        </div>
      </div>

      <div class="presets" aria-hidden="false">
        <button class="preset" data-secs="180">3 min</button>
        <button class="preset" data-secs="300">5 min</button>
        <button class="preset" data-secs="600">10 min</button>
        <button class="preset" data-secs="900">15 min</button>
      </div>

      <div id="guide" class="guide" tabindex="0"></div>
      <div class="cute-note" id="cuteNote" aria-hidden="true">You're doing great — just breathe.</div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeModal" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <script>
    const PRACTICES = [
      {id:'breath', title:'Breath Awareness', short:'Follow the natural rhythm of breathing.', guide:`Find a comfortable position. Gently bring attention to the breath. Notice inhale and exhale without changing them. If the mind wanders, kindly return to the breath.`},
      {id:'body', title:'Body Scan', short:'Progressively relax the body from toes to head.', guide:`Lie or sit comfortably. Move attention through the body — toes to head. Notice sensations without needing to change them.`},
      {id:'loving', title:'Loving-Kindness', short:'Send warm wishes to yourself and others.', guide:`Silently repeat phrases such as "May I be safe. May I be happy." Then extend to others.`},
      {id:'visual', title:'Guided Visualization', short:'Use imagery to relax (beach, forest).', guide:`Create a calming scene. Engage the senses: colors, sounds, textures, and a feeling of safety.`},
      {id:'box', title:'Box Breathing', short:'4-4-4-4 rhythmic breathing.', guide:`Inhale to 4, hold 4, exhale 4, hold 4. Repeat for several cycles.`},
      {id:'mindful', title:'Mindful Walking', short:'Anchor the mind with slow steps.', guide:`Walk slowly and notice each step. Feel feet lift and touch the ground.`}
    ];

    const practicesEl = document.getElementById('practices');
    const backdrop = document.getElementById('backdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalSub = document.getElementById('modalSub');
    const guideEl = document.getElementById('guide');
    const timerEl = document.getElementById('timer');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const presets = document.querySelectorAll('.preset');
    const closeModal = document.getElementById('closeModal');
    const cuteNote = document.getElementById('cuteNote');

    let current = null, totalSecs = 300, remaining = 300, interval = null, audioCtx = null;

    function iconPathFor(id){
      switch(id){
        case 'breath': return 'M3 12c2-6 10-6 12 0';
        case 'body': return 'M12 2a4 4 0 1 0 0 8';
        case 'loving': return 'M12 21s-8-5.2-8-9.5C4 7 7 4 12 7';
        case 'visual': return 'M2 12h20M6 8l4 4 4-4';
        case 'box': return 'M4 4h16v16H4z';
        default: return 'M12 2a10 10 0 1 0 0 20';
      }
    }

    function buildCards(){
      PRACTICES.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'card';
        btn.type = 'button';
        btn.innerHTML = `<div class="cute-badge" aria-hidden="true"><svg class="badge-ico" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="${iconPathFor(p.id)}"/></svg></div><h3>${p.title}</h3><p>${p.short}</p>`;
        btn.addEventListener('click', () => openPractice(p));
        btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPractice(p); }});
        practicesEl.appendChild(btn);
      });
    }

    function openPractice(p){
      current = p;
      modalTitle.textContent = p.title;
      modalSub.textContent = p.short;
      guideEl.textContent = p.guide;
      totalSecs = ({breath:300, body:600, loving:420, visual:420, box:300, mindful:300}[p.id]) || 300;
      remaining = totalSecs; renderTimer(); showModal();
    }

    function showModal(){ backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden','false'); pause(); cuteNote.setAttribute('aria-hidden','true'); startBtn.focus(); }
    function close(){ backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden','true'); pause(); }
    function renderTimer(){ const mm = String(Math.floor(remaining/60)).padStart(2,'0'); const ss = String(remaining%60).padStart(2,'0'); timerEl.textContent = `${mm}:${ss}`; }

    function start(){ if (!audioCtx) initAudio(); playBell(0.12,'start'); if (interval) return; interval = setInterval(()=>{ if (remaining<=0){ finish(); return; } remaining--; renderTimer(); if (remaining===10) playBell(0.06,'tiny'); },1000); startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false; }
    function pause(){ if (interval) clearInterval(interval); interval=null; startBtn.disabled=false; pauseBtn.disabled=true; }
    function reset(){ remaining=totalSecs; renderTimer(); pause(); }
    function finish(){ pause(); remaining=0; renderTimer(); playBell(0.35,'end'); cuteNote.setAttribute('aria-hidden','false'); }

    presets.forEach(p => p.addEventListener('click', () => { totalSecs = Number(p.dataset.secs) || totalSecs; remaining = totalSecs; renderTimer(); }));
    startBtn.addEventListener('click', start); pauseBtn.addEventListener('click', pause); resetBtn.addEventListener('click', reset); closeModal.addEventListener('click', close);
    backdrop.addEventListener('click', e => { if (e.target === backdrop) close(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && backdrop.style.display === 'flex') close(); });

    function initAudio(){ try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){ audioCtx = null; } }
    function playBell(duration=0.2,type='bell'){ if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = (type==='start'?880: type==='tiny'?1200: type==='end'?520:660); g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.08,audioCtx.currentTime+0.02); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+duration); o.stop(audioCtx.currentTime+duration+0.02); }

    // init
    buildCards(); renderTimer(); pauseBtn.disabled=true; resetBtn.disabled=true;
    window.addEventListener('load', () => { const hash = (location.hash||'').replace('#',''); if (hash){ const p = PRACTICES.find(x=>x.id===hash); if (p) openPractice(p); } });
  </script>
</body>
</html>