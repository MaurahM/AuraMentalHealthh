<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subscribe to Aura</title>
  <style>
    :root{
      --bg:#3b1534;
      --accent:#ff2fa6;
      --accent-light:#ff5fb5;
      --muted:#a8adc7;
      --text:#ffffff;
      --shadow:0 20px 60px rgba(255,47,166,0.12);
      --radius:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#3b1534 0%,#1a0d28 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden
    }
    
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:radial-gradient(circle at 20% 50%,rgba(255,47,166,0.08) 0%,transparent 50%),
                  radial-gradient(circle at 80% 80%,rgba(255,107,173,0.06) 0%,transparent 50%);
      pointer-events:none;
      z-index:0
    }

    main{
      position:relative;
      z-index:1;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px 20px;
    }

    .price-card{
      background:linear-gradient(135deg,rgba(255,47,166,0.06),rgba(255,107,173,0.03));
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,47,166,0.15);
      padding:48px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      width:100%;
      max-width:480px;
    }
    
    .price-card::before{
      content:'';
      position:absolute;
      top:-50%;
      right:-50%;
      width:400px;
      height:400px;
      background:radial-gradient(circle,rgba(255,47,166,0.15) 0%,transparent 70%);
      border-radius:999px
    }
    
    .price-card>*{position:relative;z-index:2}

    .price-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px}
    .price-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:8px;display:block}
    .price-amount{font-size:52px;font-weight:950;color:var(--accent);margin-bottom:6px;display:block}
    .price-period{font-size:14px;color:var(--muted)}
    .popular-badge{
      background:linear-gradient(135deg,var(--accent),var(--accent-light));
      color:#fff;
      padding:8px 14px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px
    }

    .features-list{display:flex;flex-direction:column;gap:14px;margin-bottom:32px;padding-bottom:32px;border-bottom:1px solid rgba(255,47,166,0.1)}
    .feature-item{display:flex;gap:12px;align-items:center;font-size:14px;color:var(--muted);font-weight:500}
    .feature-item::before{content:'✓';color:var(--accent);font-weight:900;flex-shrink:0;font-size:18px}

    form{}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
    input[type="tel"]{
      width:100%;
      padding:14px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,47,166,0.2);
      border-radius:10px;
      color:var(--text);
      font-size:15px;
      margin-bottom:18px;
      transition:all 0.3s;
      font-weight:500
    }
    input::placeholder{color:rgba(255,255,255,0.2)}
    input:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(255,47,166,0.08);
      box-shadow:0 0 0 3px rgba(255,47,166,0.15)
    }

    .btn{
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,var(--accent),var(--accent-light));
      border-radius:10px;
      border:0;
      color:#fff;
      font-weight:800;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 12px 32px rgba(255,47,166,0.28);
      transition:all 0.3s;
      margin-bottom:14px
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 16px 48px rgba(255,47,166,0.36)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}

    .message{
      padding:14px;
      border-radius:10px;
      font-size:13px;
      text-align:center;
      font-weight:600;
      display:none;
      margin-bottom:14px;
      border:1px solid transparent
    }
    .message.success{background:rgba(34,197,94,0.1);color:#86efac;border-color:rgba(34,197,94,0.2)}
    .message.error{background:rgba(239,68,68,0.1);color:#fca5a5;border-color:rgba(239,68,68,0.2)}

    .back-link{display:block;text-align:center;color:var(--muted);text-decoration:none;font-size:13px;margin-top:14px;font-weight:600}
    .back-link:hover{color:var(--accent)}

    footer{position:absolute;bottom:20px;left:20px;right:20px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>

<main>
  <section class="price-card">
    <div class="price-head">
      <div>
        <span class="price-label">Monthly Plan</span>
        <span class="price-amount">KES 300</span>
        <div class="price-period">Billed monthly · Cancel anytime</div>
      </div>
      
    </div>

    <div class="features-list">
      <div class="feature-item">Unlimited chat sessions</div>
      <div class="feature-item">Private journal & mood tracking</div>
      <div class="feature-item">Guided meditation & breathing</div>
      <div class="feature-item">Crisis detection & resources</div>
      <div class="feature-item">Priority email support</div>
    </div>

    <form id="payment-form" novalidate>
      <label for="phone">M-Pesa Mobile Number</label>
      <input 
        id="phone" 
        name="phone" 
        type="tel" 
        placeholder="0712 345 678" 
        inputmode="numeric"
        maxlength="13"
        required 
        aria-required="true"
      />

      <button id="submit-payment" class="btn" type="submit">Send M-Pesa Prompt</button>
      
      <div id="payment-message" class="message" role="status" aria-live="polite"></div>

      <div style="font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:14px">You'll get an M-Pesa prompt on your phone. Enter your PIN to confirm payment instantly.</div>

      <a href="Dashboard.html" class="back-link">Back</a>
    </form>
  </section>
</main>

<footer>
  Need help? <a href="mailto:support@aura.app" style="color:var(--accent);text-decoration:none">support@aura.app</a> | © 2025 Aura
</footer>

<script>
  const TOKEN_KEY = 'convai_user_token';
  const token = localStorage.getItem(TOKEN_KEY);
  if (!token) location.href = 'index.html';

  const form = document.getElementById('payment-form');
  const phoneInput = document.getElementById('phone');
  const submitBtn = document.getElementById('submit-payment');
  const messageEl = document.getElementById('payment-message');

  phoneInput.addEventListener('input', e => {
    let v = e.target.value.replace(/\D/g, '').slice(0, 10);
    if (v.length <= 4) e.target.value = v;
    else if (v.length <= 7) e.target.value = v.slice(0, 4) + ' ' + v.slice(4);
    else e.target.value = v.slice(0, 4) + ' ' + v.slice(4, 7) + ' ' + v.slice(7);
  });

  function showMessage(text, kind = 'success', duration = 5000) {
    messageEl.textContent = text;
    messageEl.className = 'message ' + kind;
    messageEl.style.display = 'block';
    if (duration > 0) {
      setTimeout(() => {
        if (messageEl.textContent === text) messageEl.style.display = 'none';
      }, duration);
    }
  }

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const raw = phoneInput.value.replace(/\s/g, '').trim();

    if (!raw || raw.length !== 10 || !raw.startsWith('07')) {
      showMessage('Please enter a valid M-Pesa number (e.g., 0712345678)', 'error');
      return;
    }

    submitBtn.disabled = true;
    const orig = submitBtn.innerHTML;
    submitBtn.innerHTML = 'Processing...';

    try {
      const res = await fetch('/api/subscription/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ phone: raw, amount: 300, currency: 'KES' })
      });

      const data = await res.json();

      if (res.ok) {
        showMessage('✓ Check your phone for the M-Pesa prompt. Enter your PIN to activate.', 'success', 0);
        setTimeout(() => location.href = 'Dashboard.html', 4000);
      } else {
        showMessage((data && data.message) || 'Payment failed. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = orig;
      }
    } catch (err) {
      console.error(err);
      showMessage('Network error. Check your connection and try again.', 'error');
      submitBtn.disabled = false;
      submitBtn.innerHTML = orig;
    }
  });
</script>

</body>
</html>